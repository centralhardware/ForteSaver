# Стратегия дедупликации транзакций

## Проблема

В PDF выписках Forte Bank **нет времени транзакции** (только дата). Это создает проблему:
- Если вы дважды купите кофе в одном кафе на одинаковую сумму в течение дня, как отличить их?
- Если загрузить ту же выписку дважды, как избежать дубликатов?

## Решение

**Уникальность = (дата_транзакции, порядковый_номер_в_этот_день)**

### Ключевое предположение

**Банк Forte сортирует транзакции по времени внутри каждого дня**, даже если время не отображается в PDF.

Это означает:
- Первая транзакция 15.10.2025 → `daily_sequence = 0`
- Вторая транзакция 15.10.2025 → `daily_sequence = 1`
- Третья транзакция 15.10.2025 → `daily_sequence = 2`

## Как работает

### База данных

```sql
CREATE UNIQUE INDEX unique_daily_transaction
ON transactions(transaction_date, daily_sequence);
```

### Логика импорта

1. Парсим PDF, получаем транзакции в порядке из файла
2. Группируем транзакции по датам
3. Присваиваем порядковые номера внутри каждой даты (0, 1, 2...)
4. Проверяем БД: есть ли уже пара (дата, daily_sequence)?
5. Импортируем только новые

## Примеры сценариев

### ✅ Сценарий 1: Повторная загрузка той же выписки

```
Первая загрузка:
- (2025-10-15, sequence=0) → импортирована
- (2025-10-15, sequence=1) → импортирована
- (2025-10-15, sequence=2) → импортирована

Вторая загрузка (тот же PDF):
- (2025-10-15, sequence=0) → пропущена (дубликат)
- (2025-10-15, sequence=1) → пропущена (дубликат)
- (2025-10-15, sequence=2) → пропущена (дубликат)
```

**Результат:** Дубликаты не создаются ✅

### ✅ Сценарий 2: Две покупки кофе в один день

```
15.10.2025:
- sequence=0: кофе в 7-ELEVEN за 3.80 MYR
- sequence=1: обед в ресторане
- sequence=2: кофе в 7-ELEVEN за 3.80 MYR (снова!)
```

Обе покупки кофе имеют **разные sequence**, поэтому обе импортируются ✅

### ✅ Сценарий 3: Выписки за разные периоды

```
Выписка за октябрь:
- 01.10: 5 транзакций (sequence 0-4)
- 15.10: 8 транзакций (sequence 0-7)
- 31.10: 3 транзакции (sequence 0-2)

Выписка за сентябрь-октябрь:
- 01.10: 5 транзакций (sequence 0-4) → те же транзакции
- 15.10: 8 транзакций (sequence 0-7) → те же транзакции
```

При повторном импорте **октябрьские транзакции будут пропущены** (та же дата + та же позиция) ✅

### ⚠️ Потенциальная проблема

Если банк изменит порядок сортировки транзакций:

```
Выписка A (сортировка по времени):
- 15.10, sequence=0: кофе 7-ELEVEN
- 15.10, sequence=1: обед

Выписка B (сортировка по сумме):
- 15.10, sequence=0: обед
- 15.10, sequence=1: кофе 7-ELEVEN
```

В этом случае транзакции поменялись местами → **обе будут импортированы как новые**.

**Решение:** Пока банк сохраняет порядок, система работает корректно.

## Преимущества

✅ **Предотвращает дубликаты** при повторной загрузке выписки
✅ **Позволяет несколько одинаковых покупок** в один день
✅ **Работает с выписками за разные периоды**
✅ **Не зависит от хеша файла** (можно загружать PDF с разных устройств)

## Миграция БД

Изменения применяются автоматически через Flyway при запуске бота:

```sql
-- V2__change_deduplication_strategy.sql
ALTER TABLE transactions ADD COLUMN daily_sequence INTEGER;
CREATE UNIQUE INDEX unique_daily_transaction
ON transactions(transaction_date, daily_sequence);
```

## Код

См. файлы:
- `src/main/kotlin/database/StatementRepository.kt` - логика дедупликации
- `src/main/kotlin/database/Tables.kt` - схема таблицы
- `src/main/resources/db/migration/V2__change_deduplication_strategy.sql` - миграция
